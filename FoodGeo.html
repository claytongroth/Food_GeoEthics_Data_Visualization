<!DOCTYPE html>
<html lang="en">
<html>
<head>

<script src="https://d3js.org/d3.v5.min.js"></script>
<!--<script src="./lib/d3-queue.v2.min.js"></script> -->
<script src="https://d3js.org/d3-queue.v3.min.js"></script>
<!--<script src="./lib/topojson.js"></script>  -->  
<script src="https://unpkg.com/topojson-client@3"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>

</head>
    
<title>D3 Learning</title>
    <meta charset="utf-8"/>
    
<style>
    path:hover {
        stroke: black;
        stroke-width: 1px;
      }
    path {
        fill: #848484;
        stroke: lightgrey;
        stroke-width: .25px;
      }
    .graticule {
        fill: none;
        stroke: #000;
        stroke-opacity: .6;
        stroke-width: .5px;
    }
    .graticule.outline {
        fill: #9ecae1;
        opacity: 0.2;
        stroke: #333;
        stroke-opacity: 1;
        stroke-width: 1px;
    }

      div.tooltip { 
          position: absolute;     
          text-align: center;     
          width: auto;          
          height: auto;         
          padding: 2px;       
          font: 12px sans-serif;    
          background: #fff; 
          border: 0px;        
          pointer-events: none;     
      }
    .map {
        border: medium solid #999;
        margin: 10px 0 0 20px;
    }
    
    .chartBackground {
        fill: white;
    }
    .chart {
        background-color: transparent;
        border: medium solid #999;
        float: right;
        margin: 10px 20px 0 0;
    }
    .chartTitle {
        font-family: sans-serif;
        font-size: 1.5em;
        font-weight: bold;
    }
    .chartSub {
        font-family: sans-serif;
        font-size: 1.5em;
        padding-top: 5px;
        font-weight: bold;
    }
    .axis path, .axis line {
        fill: none;
        stroke: #999;
        stroke-width: .15px;
        shape-rendering: crispEdges;
    }
    
    .dropdown {
    position: absolute;
    top: 30px;
    left: 40px;
    z-index: 10;
    font-family: sans-serif;
    font-size: 1em;
    font-weight: bold;
    padding: 2px;
    border: 1px solid #999;
    box-shadow: 2px 2px 4px #999;
    }

    option {
        font-weight: normal;
    }
</style>
    
    

<script>
window.onload = setMap();
function setMap(){   
    
    d3.csv("/data/nu3Food_EmissionsData2.csv").then(function(data) {
            //console.log(data);
    d3.json("/data/a.topojson").then(function(data2) {
            //console.log(data2);
    //Code with data here
        var width = window.innerWidth * 0.5, // 960
            height = 460;
        //chart vars
        var chartWidth = window.innerWidth * 0.425,
                chartHeight = 473,
                leftPadding = 25,
                rightPadding = 2,
                topBottomPadding = 5,
                chartInnerWidth = chartWidth - leftPadding - rightPadding,
                chartInnerHeight = chartHeight - topBottomPadding * 2,
                translate = "translate(" + leftPadding + "," + topBottomPadding + ")";
         var yScale = d3.scaleLinear()
                .range([0, chartHeight])
                .domain([0, 2000]); 

        //create new svg container for the map
        var map = d3.select("body")
            .append("svg")
            .attr("class", "map")
            .attr("width", width)
            .attr("height", height);
        
        //create new svg container for the chart
        var chart = d3.select("body")
            .append("svg")
            .attr("width", chartWidth)
            .attr("height", chartHeight)
            .attr("class", "chart");

        //create Albers equal area conic projection centered on France
        var projection = d3.geoNaturalEarth1()
            .center([0, 0])
            .rotate([-2, 0, 0])
            //.parallels([43, 62])
            .scale(175)
            .translate([width / 2, height / 2]);
        var path = d3.geoPath()
            .projection(projection);
           //translate TopoJSON
        d3.selectAll(".boundary")
        .style("stroke-width", 1 / 1);
        
        var b = topojson.feature(data2, data2.objects.ne_10m_admin_0_countries);
        //console.log(b)
        //console.log(b.features[1].properties.ADMIN) //country name
        var graticule = d3.geoGraticule();
        
        var attrArray = ["Pork (Supplied Kg/Person/Year)",	"Pork (kg/CO2/Person/Year)",	"Poultry (Supplied Kg/Person/Year)",	"Poultry (kg/CO2/Person/Year)",	"Beef (Supplied Kg/Person/Year)",	"Beef (kg/CO2/Person/Year)",	"LambGoat (Supplied Kg/Person/Year)",	"LambGoat (kg/CO2/Person/Year)",	"Fish (Supplied Kg/Person/Year)",	"Fish (kg/CO2/Person/Year)",	"Eggs (Supplied Kg/Person/Year)",	"Eggs (kg/CO2/Person/Year)",	"Dairy (Supplied Kg/Person/Year)",	"Dairy (kg/CO2/Person/Year)",	"Animal Total (kg/CO2/Person/Year)",	"Wheat (Supplied Kg/Person/Year)",	"Wheat (kg/CO2/Person/Year)",	"Rice (Supplied Kg/Person/Year)",	"Rice (kg/CO2/Person/Year)",	"Soy (Supplied Kg/Person/Year)",	"Soy (kg/CO2/Person/Year)",	"Nuts (Supplied Kg/Person/Year)",	"Nuts (kg/CO2/Person/Year)",	"Non-Animal Total (kg/CO2/Person/Year)",	"Difference Animal-Nonanimal (kg/CO2/Person/Year)"];

        function joinData(b, data){
        //loop through csv to assign each set of csv attribute values to geojson region
            for (var i=0; i<data.length; i++){
                var csvRegion = data[i]; //the current region
                var csvKey = data[i].Country; //the CSV primary key
                  //console.log(data[i].Country)
            //loop through geojson regions to find correct region
                for (var a=0; a<b.features.length; a++){     
                    var geojsonProps = b.features[a].properties; //gj props
                    var geojsonKey = geojsonProps.ADMIN; //the geojson primary key
                    //where primary keys match, transfer csv data to geojson properties object
                    if (geojsonKey == csvKey){
                        //assign all attributes and values
                        attrArray.forEach(function(attr){
                            var val = parseFloat(csvRegion[attr]); //get csv attribute value
                            geojsonProps[attr] = val; //assign attribute and value to geojson properties
                        });
                    };

                };
            };
            return b;
      };
        joinData(b,data);
        
        //console.log(b.features[0].properties.ADMIN)
        //console.log(b.features[1].properties.ADMIN)
        //console.log(b.features)
        

        var tooltip = d3.select("body").append("div") 
            .attr("class", "tooltip")       
            .style("opacity", 0);

        //Dynamically Call the current food variable to change the map
        var currentFood = "Beef2";
        
        
        var valArray = [];
        data.forEach(function(element) {
            valArray.push(parseInt(element[currentFood]));
        });
        
        var currentMax = Math.max.apply(null, valArray.filter(function(n) { return !isNaN(n); }));
        console.log("Current Max Value is " + currentMax + " for " + currentFood)
        
                
        function highlight(props){
            //change stroke
            var selected = d3.selectAll("." + props.Country)
                .style("stroke", "blue")
                .style("stroke-width", "2");
        };
        
        var color = d3.scaleQuantile()
            .domain(d3.range(0, (currentMax + 10)))
            .range(d3.schemeReds[7]); 
        
        
        function drawMap(currentMax){
            
            d3.selectAll("path").remove();
            // Going to need to do this dynamically
            // Set to ckmeans
            var color = d3.scaleQuantile()
                .domain(d3.range(0, currentMax))
                .range(d3.schemeReds[7]);  

            //console.log(b[1].Beef1)


            map.append("path")
                .datum(graticule)
                .attr("class", "graticule")
                .attr("d", path);

            map.append("path")
                .datum(graticule.outline)
                .attr("class", "graticule outline")
                .attr("d", path);


        console.log(map.selectAll("path").size())

           map.selectAll("countries")
                .data(b.features)
                .enter()
                .append("path")
                .attr("d", path)
                //.style("stroke", "black")
                .on("mouseover", function(d) {    
                    tooltip.transition()    //(this.parentNode.appendChild(this))
                    .duration(200)    
                    .style("opacity", .9)
                    .style("stroke-opacity", 1.0);    
                    tooltip.html(d.properties.ADMIN + "<br/>"  + d.properties[currentFood] + "(kg/CO2/Person/Year)")  
                    .style("left", (d3.event.pageX) + "px")   
                    .style("top", (d3.event.pageY - 28) + "px");
                  })          
                  .on("mouseout", function(d) {   
                    tooltip.transition()    
                    .duration(500)    
                    .style("opacity", 0)
                    .style("stroke-opacity", 0); 
                  })
                .style("fill", function(d) { return color(d.properties[currentFood]) });


        };

        drawMap(currentMax);
        console.log("sum", d3.sum(valArray))

                                  
        function setChart(data, data2, currentMax, valArray){
            
            d3.selectAll("rect").remove();
            d3.selectAll("text").remove();
            
            var color = d3.scaleQuantile()
                .domain(d3.range(0, (currentMax + 10)))
                .range(d3.schemeReds[7]); 
            var chartBackground = chart.append("rect")
                .attr("class", "chartBackground")
                .attr("width", chartInnerWidth)
                .attr("height", chartInnerHeight)
                .attr("transform", translate);
            
            var yScale = d3.scaleLinear()
                .range([0, chartHeight])
                .domain([0, (currentMax+10)]);

            var chartTitle = chart.append("text")
                .attr("x", 20)
                .attr("y", 40)
                .attr("class", "chartTitle")
                .text(currentFood.slice(0, -1));
            var chartSub = chart.append("text")
                .attr("x", 20)
                .attr("y", 90)
                .attr("class", "chartSub")
                .text((d3.sum(valArray)*76) + " Billion  World Total");
            
                // Place Axis at some point
            var bars = chart.selectAll(".bars")
                .data(data)
                .enter()
                .append("rect")
                .on("mouseover", function(d) {    
                    tooltip.transition()    //(this.parentNode.appendChild(this))
                    .duration(200)    
                    .style("opacity", .9)
                    .style("stroke-opacity", 1.0);    
                    tooltip.html(d.Country + "<br/>"  + d[currentFood] + "(kg/CO2/Person/Year)")  
                    .style("left", (d3.event.pageX) + "px")   
                    .style("top", (d3.event.pageY - 28) + "px");  
                  })          
                  .on("mouseout", function(d) {   
                    tooltip.transition()    
                    .duration(500)    
                    .style("opacity", 0)
                    .style("stroke-opacity", 0); 
                  })
                .sort(function(a, b){
                return a[currentFood]-b[currentFood]
                })
                .transition() //add animation
                    .delay(function(d, i){
                        return i * 5
                    })
                    .duration(1)
                .attr("class", function(d){
                    return "bars" + d.Country;
                })
                .attr("width", chartWidth / data.length - 1)
                .attr("x", function(d, i){
                    return i * (chartWidth / data.length);
                })
                .attr("height", function(d){
                    return yScale(parseFloat(d[currentFood]));
                })
                .attr("y", function(d){
                    return chartHeight - yScale(parseFloat(d[currentFood]));
                })
                .style("fill", function(d){ return color(d[currentFood]); }); 
            
        };
        
        setChart(data, data2, currentMax, valArray);  

        
        function createDropdown(data){
            //add select element
            var dropdown = d3.select("body")
                .append("select")
                .attr("class", "dropdown")
                .on("change", function(){
                changeAttribute(this.value, data)
                });

            //add initial option
            var titleOption = dropdown.append("option")
                .attr("class", "titleOption")
                .attr("disabled", "true")
                .text("Select Attribute");

            //add attribute name options
            var attrOptions = dropdown.selectAll("attrOptions")
                .data(attrArray)
                .enter()
                .append("option")
                .attr("value", function(d){ return d })
                .text(function(d){ return d });
        };
        createDropdown(data);
        
        function changeAttribute(attribute, data){
            //change the expressed attribute
            currentFood = attribute;
            var valArray = [];
            data.forEach(function(element) {
                valArray.push(parseInt(element[currentFood]));
            });
        
            var currentMax = Math.max.apply(null, valArray.filter(function(n) { return !isNaN(n); }));
            console.log("Current Max Value is " + currentMax + " for " + currentFood)
            
            // Set a dynamic color range
            
            var color = d3.scaleQuantile()
                .domain(d3.range(0, currentMax))
                .range(d3.schemeReds[7]); 
            
            //recolor enumeration units
            drawMap(currentMax);
            //reset chart bars
            setChart(data, data2, currentMax, valArray);

        };
        
    }); //csv
    }); //json
 
 
}; // end of setmap  
    
    // d3.max and d3.min for creating ranges (dynamic color)
    
  //   http://bl.ocks.org/MaciejKus/61e9ff1591355b00c1c1caf31e76a668  
// USe the above to set up my page.
// I want a bar graph, pie chart, and enter in my data/unviersalize it
    
// 1(Supplied Kg/Person/Year)
// 2(kg/CO2/Person/Year)
    // User enters data that determines their KGs of each consumed.
    // They get run as a percentage and the new (kg/CO2/Person/Year) is calculated from that percentage assuming a      //linear relationship
    
// https://ourworldindata.org/meat-and-seafood-production-consumption
    
    
</script>
<!--
       map.append("path")
            .datum(b)
            .style("stroke", "black")
            .style("fill", function(d) { return color(d.rate = b.features[1].properties.Beef1); })
            .attr("d", path);
-->